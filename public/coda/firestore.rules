service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
        function userIsAllowed(datasetResource){
           return request.auth.token.email in datasetResource.data.users 
        }
        function getDatasetResource(){
            return get(/databases/$(database)/documents/$(documents))
        }
        allow read: if userIsAllowed(resource)
      match /metrics/{metrics=**} {
      	allow read, write: if userIsAllowed(getDatasetResource())
      }
    }
  }
  